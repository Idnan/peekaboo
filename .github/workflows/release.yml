name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true

env:
  APP_NAME: Peekaboo
  SCHEME: Peekaboo

jobs:
  build:
    runs-on: macos-14
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set version from tag or input
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_ENV
          else
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
          fi

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install tools
        run: |
          brew install create-dmg
          # Download Sparkle for signing tools
          curl -L -o /tmp/Sparkle.tar.xz https://github.com/sparkle-project/Sparkle/releases/download/2.6.4/Sparkle-2.6.4.tar.xz
          mkdir -p /tmp/Sparkle
          tar -xf /tmp/Sparkle.tar.xz -C /tmp/Sparkle

      - name: Update version in project
        run: |
          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" Peekaboo/Resources/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $VERSION" Peekaboo/Resources/Info.plist

      - name: Resolve Swift Package Dependencies
        run: xcodebuild -resolvePackageDependencies -project ${{ env.APP_NAME }}.xcodeproj -scheme ${{ env.SCHEME }}

      - name: Build
        run: |
          xcodebuild -project ${{ env.APP_NAME }}.xcodeproj \
            -scheme ${{ env.SCHEME }} \
            -configuration Release \
            -derivedDataPath build \
            -arch arm64 -arch x86_64 \
            ONLY_ACTIVE_ARCH=NO \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Create DMG
        run: |
          APP_PATH="build/Build/Products/Release/${{ env.APP_NAME }}.app"
          DMG_NAME="${{ env.APP_NAME }}-${{ env.VERSION }}.dmg"
          
          create-dmg \
            --volname "${{ env.APP_NAME }}" \
            --volicon "$APP_PATH/Contents/Resources/AppIcon.icns" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "${{ env.APP_NAME }}.app" 150 185 \
            --hide-extension "${{ env.APP_NAME }}.app" \
            --app-drop-link 450 185 \
            "$DMG_NAME" \
            "$APP_PATH" || true
          
          # Fallback if create-dmg fails
          if [ ! -f "$DMG_NAME" ]; then
            hdiutil create -volname "${{ env.APP_NAME }}" -srcfolder "$APP_PATH" -ov -format UDZO "$DMG_NAME"
          fi

      - name: Create ZIP
        run: |
          APP_PATH="build/Build/Products/Release/${{ env.APP_NAME }}.app"
          ZIP_NAME="${{ env.APP_NAME }}-${{ env.VERSION }}.zip"
          cd "build/Build/Products/Release"
          zip -r -y "../../../../$ZIP_NAME" "${{ env.APP_NAME }}.app"

      - name: Sign update and generate appcast
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # Write private key to temp file
          if [ -z "$SPARKLE_PRIVATE_KEY" ]; then
            echo "::error::SPARKLE_PRIVATE_KEY secret not set"
            exit 1
          fi
          echo "$SPARKLE_PRIVATE_KEY" > /tmp/sparkle_private_key
          
          # Generate appcast item using script
          ZIP_NAME="${{ env.APP_NAME }}-${{ env.VERSION }}.zip"
          ./scripts/generate-appcast.sh "${{ env.VERSION }}" "$ZIP_NAME" "https://github.com/${{ github.repository }}" /tmp/sparkle_private_key > /tmp/new_item.xml
          
          # Clean up private key
          rm -f /tmp/sparkle_private_key
          
          # Insert new item into appcast.xml after <language>en</language>
          sed -i '' '/<language>en<\/language>/r /tmp/new_item.xml' appcast.xml
          
          rm -f /tmp/new_item.xml
          cat appcast.xml

      - name: Commit updated appcast
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add appcast.xml
          git commit -m "Update appcast.xml for v${{ env.VERSION }}" || echo "No changes to commit"
          git push origin HEAD:main

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            *.dmg
            *.zip

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.dmg
            *.zip
          draft: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

